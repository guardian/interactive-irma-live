<div id="map"></div>
<script>
import { defaultMapStyle } from './defaultMapStyle'
import probTopojson from '../../assets/topo2.json'
import * as topojson from "topojson-client";

console.log(probTopojson)

export default {
    oncreate() {
        markers = this.get("markers");
        choropleth = this.get("choropleth");
        config = Object.assign(defaultConfig, this.get("config"));
        markerConfig = Object.assign(defaultMarkerConfig, this.get("markerConfig"));
        var el = document.createElement('script');

        el.src = `https://maps.googleapis.com/maps/api/js?key=${this.get("key")}&callback=initMap`;
        document.body.appendChild(el);
    }
}

let infowindow;
let markers;
let config;
let markerConfig;
let choropleth;
let features;

const defaultConfig = {
    center: { lat: 30.7316306, lng: -94.9396368 },
    scrollwheel: true,
    mapTypeControl: false,
    streetViewControl: false,
    zoom: 4,
    draggable: true,
    panControl: false,
    zoomControl: true
    // gestureHandling: "greedy"
}

const defaultMarkerConfig = {
    markerSize: 5,
    infoWindowWidth: 250,
    url: `${process.env.PATH}/assets/map-icon.png`
}

window.initMap = () => {
    const map = new google.maps.Map(document.querySelector("#map"), Object.assign(defaultConfig, config));

    const windowOrWindowParent = (inIframe) ? window.parent : window;

    const isAndroidApp = (windowOrWindowParent.location.origin === "file://" && /(android)/i.test(navigator.userAgent)) ? true : false;

    if (isAndroidApp) {
        google.maps.event.addListener(map, "dragstart", function(event) {
            windowOrWindowParent.GuardianJSInterface.registerRelatedCardsTouch(true);
        }, true);
        google.maps.event.addListener(map, "dragend", function(event) {
            windowOrWindowParent.GuardianJSInterface.registerRelatedCardsTouch(false);
        }, true);
    }

    map.mapTypes.set('styled_map', new google.maps.StyledMapType(defaultMapStyle));
    map.setMapTypeId('styled_map');

    // const categories = [["<5%", "5-10%"], ["40-50%", "30-40%", "20-30%", "10-20%"], ["50-60%", "60-70%", "70-80%", "80-90%"], [">90%"]]

    // const titles = ['<10%', '10-50%', '50-90%', '>90%']

    // const merged = {
    //     type : 'FeatureCollection',
    //     features : categories.map( (probs, i) => {

    //         return {
    //             'geometry' : topojson.merge(topo, topo.objects[].geometries.filter(d => probs.indexOf(d.properties.PERCENTAGE >= 0))) ,
    //             'type' : 'Feature'
    //             'properties' : titles[i],
    //         }

    //     } )
    // }

    const geojson = {
        type: "FeatureCollection",
        features: [{

                "geometry": topojson.merge(probTopojson, probTopojson.objects["2017090606_wsp34knt120hr_5km"].geometries.filter(d => [">90%"].indexOf(d.properties.PERCENTAGE) > -1)),
                "properties": {
                    "band": ">90%"
                },
                "type": "Feature"
            },
            {

                "geometry": topojson.merge(probTopojson, probTopojson.objects["2017090606_wsp34knt120hr_5km"].geometries.filter(d => ["50-60%", "60-70%", "70-80%", "80-90%"].indexOf(d.properties.PERCENTAGE) > -1)),
                "properties": {
                    "band": "50-90%"
                },
                "type": "Feature"
            },
            {

                "geometry": topojson.merge(probTopojson, probTopojson.objects["2017090606_wsp34knt120hr_5km"].geometries.filter(d => ["40-50%", "30-40%", "20-30%", "10-20%"].indexOf(d.properties.PERCENTAGE) > -1)),
                "properties": {
                    "band": "10-50%"
                },
                "type": "Feature"
            },
            {

                "geometry": topojson.merge(probTopojson, probTopojson.objects["2017090606_wsp34knt120hr_5km"].geometries.filter(d => ["<5%", "5-10%"].indexOf(d.properties.PERCENTAGE) > -1)),
                "properties": {
                    "band": "<10%"
                },
                "type": "Feature"
            }
        ]
    };

    map.data.addGeoJson(geojson)
    map.data.setStyle(choropleth)

    // var kmzLayer = new google.maps.KmlLayer('http://www.nhc.noaa.gov/storm_graphics/api/AL112017_029adv_TRACK.kmz');
    // kmzLayer.setMap(map);

    if (markers && markers.length > 0) {
        markers.forEach((m) => {
            const markerSize = defaultMarkerConfig.markerSize;
            const marker = new google.maps.Marker({
                map: map,
                position: m,
                icon: {

                    url: markerConfig.url,
                    scaledSize: new google.maps.Size(markerConfig.markerSize, markerConfig.markerSize)
                }
            });

            if (m.label) {
                marker.addListener('click', function() {
                    if (infowindow) {
                        infowindow.close();
                    }

                    infowindow = new google.maps.InfoWindow({
                        content: m.label,
                        maxWidth: markerConfig.infoWindowWidth
                    });

                    infowindow.open(map, marker);

                });
            }

            var mapLabel = new MapLabel({
                text: 'Test',
                position: new google.maps.LatLng(m.lat, m.lng),
                map: map,
                fontSize: 35,
                align: 'right'
            });

        });
    }

    window.map = map;
}

function inIframe() {
    try {
        return window.self !== window.top;
    } catch (e) {
        return true;
    }
}
</script>